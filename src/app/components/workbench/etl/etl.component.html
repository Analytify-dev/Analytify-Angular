<div class="main-container container-fluid mt-5">
    <div class="row ">
        <div class="col-md-12 mt-4">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between  align-items-center m-2">
                        <div>
                            <h5 class="card-title mb-0">ETL</h5>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="d-lg-flex d-block">
                        <div class="col-2 p-1 border-end" [ngStyle]="{ 'display': isOpen ? 'block' : 'none' }">
                            <div class="card mb-0 connections-layer-h">
                                <ul ngbNav #nav="ngbNav" [(activeId)]="active" class="nav flex-column nav-pills" id="vertical-tab" role="tablist" aria-orientation="vertical">
                                    <li [ngbNavItem]="1">
                                        <!-- <a ngbNavLink class="p-3 TabShadow">Data Flow</a> -->
                                        <div ngbAccordion [closeOthers]="true" class="accordion border-0" id="accordionExample">
                                            <div ngbAccordionItem [collapsed]="false" class="accordion-item">
                                                <h2 ngbAccordionHeader class="accordion-header" id="headingOne">
                                                    <button ngbAccordionButton class="accordion-button py-3 px-3" type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                        <i class="fa fa-plug ms-2 plug-icon"></i>Connections
                                                    </button>
                                                </h2>
                                                <div ngbAccordionCollapse id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
                                                    data-bs-parent="#accordionExample">
                                                    <div class="accordion-body p-0" ngbAccordionBody>
                                                        <ng-template>
                                                            <div class="data-cdk-tables px-3 mt-2">
                                                                <div class="drag-drawflow" draggable="true" (dragstart)="onDragStart($event, 'source_data_object', connectionList)" data-node="Source Data Object">
                                                                    <img src="./assets/images/etl/dataobject-etl.svg" alt="Source Data Object" class="drawflow-image"><span> Source Data Object</span>
                                                                </div>
                                                                <div class="drag-drawflow" draggable="true" (dragstart)="onDragStart($event, 'target_data_object', connectionList)" data-node="data object">
                                                                    <img src="./assets/images/etl/dataobject-etl.svg" alt="Target Data Object" class="drawflow-image"><span> Target Data Object</span>
                                                                </div>
                                                            </div>
                                                        </ng-template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div ngbAccordion [closeOthers]="true" class="accordion border-0" id="accordionExample">
                                            <div ngbAccordionItem [collapsed]="true" class="accordion-item">
                                                <h2 ngbAccordionHeader class="accordion-header" id="headingOne">
                                                    <button ngbAccordionButton class="accordion-button py-3 px-3" type="button" data-bs-toggle="collapse"
                                                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                        <i class="fa fa-gears me-2"></i>Transforms
                                                    </button>
                                                </h2>
                                                <div ngbAccordionCollapse id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
                                                    data-bs-parent="#accordionExample">
                                                    <div class="accordion-body p-0" ngbAccordionBody>
                                                        <ng-template>
                                                            <div class="data-cdk-tables px-3 mt-2">
                                                                <div class="drag-drawflow" draggable="true" (dragstart)="onDragStart($event, 'Expression', null)" data-node="Expression">
                                                                    <img src="./assets/images/etl/expression-etl.svg" alt="Expression" class="drawflow-image"><span> Expression</span>
                                                                </div>
                                                                <div class="drag-drawflow" draggable="true" (dragstart)="onDragStart($event, 'Joiner', null)" data-node="Joiner">
                                                                    <img src="./assets/images/etl/mjoiner-etl.svg" alt="Joiner" class="drawflow-image"><span> Joiner</span>
                                                                </div>
                                                                <div class="drag-drawflow" draggable="true" (dragstart)="onDragStart($event, 'Rollup', null)" data-node="Rollup">
                                                                    <img src="./assets/images/etl/rollup-etl.svg" alt="Rollup" class="drawflow-image"><span> Rollup</span>
                                                                </div>
                                                                <div class="drag-drawflow" draggable="true" (dragstart)="onDragStart($event, 'Filter', null)" data-node="Filter">
                                                                    <img src="./assets/images/etl/filter-etl.svg" alt="Filter" class="drawflow-image"><span> Filter</span>
                                                                </div>
                                                            </div>
                                                        </ng-template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <ng-template ngbNavContent>
                                            <div id="drawflow" #drawflow [ngClass]="isOpen ? 'drawflow-width-half' : 'drawflow-width-full'" (drop)="onDrop($event)" (dragover)="onDragOver($event)">
                                            </div>
                                        </ng-template>
                                    </li>
                                    <!-- <li [ngbNavItem]="2">
                                        <a ngbNavLink class="p-3 TabShadow">Job Flow</a>
                                        <ng-template ngbNavContent>
                                            <div id="drawflow" #drawflow [ngClass]="isOpen ? 'drawflow-width-half' : 'drawflow-width-full'" (drop)="onDrop($event)" (dragover)="onDragOver($event)">
                                            </div>
                                        </ng-template>
                                    </li> -->
                                </ul>
                            </div>
                           
                        </div>
                        <div class="col-10 py-0">
                            <div type="button" class="card mb-0 hide-show-btn btn-primary" (click)="isOpen = !isOpen">
                                <i *ngIf="isOpen" class="fa fa-angle-left fs-18"></i>
                                <i *ngIf="!isOpen" class="fa fa-angle-right fs-18"></i>
                            </div>
                            <div class="d-flex justify-content-end mb-2">
                                <input type="text" placeholder="ETL Name" class="form-control me-1" [(ngModel)]="etlName">
                                <button type="button" class="btn btn-primary me-1 iconProperties" style="width: 60px;" [disabled]="!etlName" (click)="saveEtlDataFlow()">Save</button>
                                <!-- <button type="button" class="btn btn-primary me-1 iconProperties" (click)="getDataFlowLogs()">Export</button> -->
                                <button type="button" class="btn btn-primary me-1 iconProperties" style="width: 60px;" [disabled]="!isRunEnable" (click)="runDataFlow()">Run</button>
                                <button type="button" class="btn btn-primary me-1 iconProperties" style="width: 60px;" [disabled]="!isRunEnable" (click)="getDataFlowStatus(runId)">Refresh</button>
                            </div>
                            <div [ngbNavOutlet]="nav"></div>
                            <div *ngIf="isNodeSelected" class="card mb-0 border customsql-result-preview-h mt-3">
                                <div class="card-body p-0 border rounded-3">
                                    <div class="card-header bg-light d-flex align-items-center justify-content-between">
                                        <ul ngbNav #tableTypes="ngbNav" [(activeId)]="tableTypeTabId" class="nav panel-tabs fs-14 pb-1">
                                            <li [ngbNavItem]="1"> 
                                                <a ngbNavLink class="p-3 TabShadow"><h6 class="mb-0 me-2"> {{selectedNode.data.nodeData.general.name}} </h6></a>
                                                <ng-template ngbNavContent>
                                                    <div class="d-lg-flex d-block">
                                                        <div class="border-end node-table-left">
                                                            <ul ngbNav #tableTabs="ngbNav" [(activeId)]="tableTabId" class="nav flex-column nav-pills" id="vertical-tab"
                                                                role="tablist" aria-orientation="vertical">
                                                                <li [ngbNavItem]="1" className="nav-link text-start" id="general-tab"><a ngbNavLink>General</a>
                                                                    <ng-template ngbNavContent>
                                                                        <div class="tab-pane" id="years" role="tabpanel" aria-labelledby="years-tab" tabindex="0"
                                                                            style="height: 280px;">
                                                                            <div class="col-xl-12 col-lg-12 col-md-12 row g-0">
                                                                                <div class="form-group w-100">
                                                                                    <label for="name" class="fw-bold">Name</label>
                                                                                    <div class="d-flex">
                                                                                        <div class="col-4 p-0">
                                                                                            <input type="text" id="name" name="name" [(ngModel)]="nodeName"
                                                                                                class="form-control shadow-sm" />
                                                                                        </div>
                                                                                        <span class="bg-primary d-flex align-items-center justify-content-center w-30"
                                                                                            (click)="updateNode('general')"><i
                                                                                                class="fa fa-chevron-right text-light fs-5"></i></span>
                                                                                    </div>
                                                                                </div>
                                                                                <!-- <div class="form-group w-100">
                                                                                    <label for="description" class="fw-bold mb-2">Description</label>
                                                                                    <textarea id="description" name="description" rows="3"
                                                                                        class="form-control shadow-sm"></textarea>
                                                                                </div>
                                                                                <div class="">
                                                                                    <input type="checkbox" id="persist" name="persist" />
                                                                                    <label for="persist" style="font-weight: bold;"> Persist Data</label>
                                                                                </div> -->
                                                                            </div>
                                                                        </div>
                                                                    </ng-template>
                                                                </li>
                                                                <li *ngIf="!['Expression','source_data_object'].includes(selectedNode.data.type)" [ngbNavItem]="2" className="nav-link text-start" id="properties-tab"><a ngbNavLink>Properties</a>
                                                                    <ng-template ngbNavContent>
                                                                        <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                            <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                <div *ngIf="selectedNode.data.type === 'Rollup'">
                                                                                    <label for="havingClause" style="font-weight: bold;"> Having Clause </label><br>
                                                                                    <div class="d-flex">
                                                                                        <textarea id="havingClause" name="havingClause" rows="3"
                                                                                            [(ngModel)]="selectedNode.data.nodeData.properties.havingClause"
                                                                                            (blur)="updateNode('properties')"></textarea>
                                                                                        <span class="bg-primary d-flex align-items-center justify-content-center"
                                                                                            style="width: 30px;" (click)="updateNode('properties')"><i
                                                                                                class="fa fa-chevron-right text-light" style="font-size: 20px;"></i></span>
                                                                                    </div>
                                                                                </div>
                                                                                <div *ngIf="selectedNode.data.type === 'Filter'">
                                                                                    <label for="filterCondition" style="font-weight: bold;"> Filter Condition </label><br>
                                                                                    <div class="d-flex">
                                                                                        <textarea id="filterCondition" name="filterCondition" rows="3"
                                                                                            [(ngModel)]="selectedNode.data.nodeData.properties.filterCondition"
                                                                                            (blur)="updateNode('properties')"></textarea>
                                                                                        <span class="bg-primary d-flex align-items-center justify-content-center"
                                                                                            style="width: 30px;" (click)="updateNode('properties')"><i
                                                                                                class="fa fa-chevron-right text-light" style="font-size: 20px;"></i></span>
                                                                                    </div>
                                                                                </div>
                                                                                <div *ngIf="selectedNode.data.type === 'Joiner'">
                                                                                    <label for="primaryObject" style="font-weight: bold;">Primary Object</label><br>
                                                                                    <ng-select style="width: 300px;" [items]="selectedNode.data.nodeData.properties.nodeNamesDropdown"
                                                                                        (change)="updateNode('properties')" placeholder="Select a primary Object" [searchable]="true"
                                                                                        [(ngModel)]="selectedNode.data.nodeData.properties.primaryObject" [dropdownPosition]="'bottom'">
                                                                                    </ng-select>
                                                                                    <table
                                                                                        class="table border text-nowrap text-md-nowrap table-striped table-bordered mb-0 mt-2">
                                                                                        <thead class="Result-preview-table-sticky">
                                                                                            <tr>
                                                                                                <th>#</th>
                                                                                                <th>Joiner Type</th>
                                                                                                <th>Secondary Object</th>
                                                                                                <th>Joiner Condition</th>
                                                                                            </tr>
                                                    
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            @for(join of selectedNode.data.nodeData.properties.joinList; track join; let i = $index){
                                                                                                <tr>
                                                                                                <td>{{i+1}}</td>
                                                                                                <td>
                                                                                                    <select class="form-select form-select" [(ngModel)]="join.joinType" (change)="updateNode('properties')">
                                                                                                        <option value="" selected disabled>Select Join Type</option>
                                                                                                        <option value="inner join">INNER JOIN</option>
                                                                                                        <option value="left outer join">LEFT OUTER JOIN</option>
                                                                                                        <option value="full outer join">FULL OUTER JOIN</option>
                                                                                                        <option value="right outer join">RIGHT OUTER JOIN</option>
                                                                                                    </select>
                                                                                                </td>
                                                                                                <td>
                                                                                                    <ng-select [items]="selectedNode.data.nodeData.properties.nodeNamesDropdown" (change)="updateNode('properties')"
                                                                                                        placeholder="Select a secondary Object" [searchable]="true"
                                                                                                        [(ngModel)]="join.secondaryObject" [dropdownPosition]="'bottom'">
                                                                                                    </ng-select>
                                                                                                </td>
                                                                                                <td> 
                                                                                                    <input type="text" class="form-control form-control" placeholder="join condition" [(ngModel)]="join.joinCondition" (blur)="updateNode('properties')"> 
                                                                                                </td>
                                                                                                </tr>
                                                                                                }
                                                                                        </tbody>
                                                                                    </table><br>
                                                                                    <div>
                                                                                        <label for="whereClause" style="font-weight: bold;"> Where Clause </label><br>
                                                                                        <div class="d-flex">
                                                                                            <textarea id="whereClause" name="whereClause" rows="3"
                                                                                                [(ngModel)]="selectedNode.data.nodeData.properties.whereClause"
                                                                                                (blur)="updateNode('properties')"></textarea>
                                                                                            <span class="bg-primary d-flex align-items-center justify-content-center"
                                                                                                style="width: 30px;" (click)="updateNode('properties')"><i
                                                                                                    class="fa fa-chevron-right text-light"
                                                                                                    style="font-size: 20px;"></i></span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <div *ngIf="selectedNode.data.type === 'source_data_object'">
                                                                                    <table
                                                                                        class="table border text-nowrap text-md-nowrap table-striped table-bordered mb-0">
                                                                                        <thead class="Result-preview-table-sticky">
                                                                                            <tr>
                                                                                                <th>Property</th>
                                                                                                <th>Value</th>
                                                                                            </tr>
                                                    
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            <tr>
                                                                                                <td>Strict Names</td>
                                                                                                <td>No</td>
                                                                                            </tr>
                                                                                            <tr>
                                                                                                <td>Where Clause</td>
                                                                                                <td> <input type="text"> </td>
                                                                                            </tr>
                                                                                            <tr>
                                                                                                <td>Distinct Row</td>
                                                                                                <td>
                                                                                                    <select name="" id="">
                                                                                                        <option value="">No</option>
                                                                                                        <option value="">Yes</option>
                                                                                                    </select>
                                                                                                </td>
                                                                                            </tr>
                                                                                            <tr>
                                                                                                <td>Source Row Limit</td>
                                                                                                <td> <input type="text"> </td>
                                                                                            </tr>
                                                                                            <tr>
                                                                                                <td>Enable Override Source Query</td>
                                                                                                <td>
                                                                                                    <select name="" id="">
                                                                                                        <option value="">No</option>
                                                                                                        <option value="">Yes</option>
                                                                                                    </select>
                                                                                                </td>
                                                                                            </tr>
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                                <div *ngIf="selectedNode.data.type === 'target_data_object'">
                                                                                    <div *ngIf="!selectedNode.data.nodeData.properties.create">
                                                                                        <input type="checkbox" id="truncate" name="truncate"
                                                                                            [(ngModel)]="selectedNode.data.nodeData.properties.truncate"
                                                                                            (change)="updateNode('properties')" />
                                                                                        <label for="truncate"> Truncate Before Load</label>
                                                                                    </div>
                                                                                    <!-- <div>
                                                                                                                                        <input type="checkbox" id="create" name="create" [(ngModel)]="selectedNode.data.nodeData.properties.create" (change)="updateNode('properties')" />
                                                                                                                                        <label for="create"> Create Target</label>
                                                                                                                                    </div> -->
                                                                                    <!-- <div>
                                                                                        <label for="preSQL" style="font-weight: bold;">Pre-SQL</label><br>
                                                                                        <textarea id="preSQL" name="preSQL" rows="3"></textarea>
                                                                                    </div>
                                                                                    <div>
                                                                                        <label for="postSQL" style="font-weight: bold;">Post-SQL</label><br>
                                                                                        <textarea id="postSQL" name="postSQL" rows="3"></textarea>
                                                                                    </div> -->
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </ng-template>
                                                                </li>
                                                                <li *ngIf="selectedNode.data.type === 'Rollup'" [ngbNavItem]="3" className="nav-link text-start"
                                                                    id="group-attributes-tab"><a ngbNavLink>Group Attributes</a>
                                                                    <ng-template ngbNavContent>
                                                                        <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                            <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                <div class="d-flex justify-content-end align-items-center gap-2 mb-3">
                                                                                    <button class="btn btn-sm btn-primary d-flex align-items-center" ngbTooltip="Add" [triggers]="'hover'" [triggers]="'hover'"
                                                                                        (click)="openAttributesSelection(attributesSelection)">
                                                                                        <i class="fa fa-plus me-1"></i> Select Attribute To Add
                                                                                    </button>
                                                    
                                                                                    <div class="input-group input-group-sm" style="max-width: 200px; height: 29px;">
                                                                                        <input type="text" class="form-control" placeholder="Search" />
                                                                                        <span class="input-group-text bg-primary" ngbTooltip="Search" [triggers]="'hover'">
                                                                                            <i class="fa fa-search text-light"></i>
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                                <div style="height: 240px;">
                                                                                    <table
                                                                                        class="table border text-nowrap text-md-nowrap table-striped table-bordered mb-0">
                                                                                        <thead class="Result-preview-table-sticky">
                                                                                            <tr>
                                                                                                <th>#</th>
                                                                                                <th>Alias Name</th>
                                                                                                <th>Select Column</th>
                                                                                                <th>Data Type</th>
                                                                                                <th>Action</th>
                                                                                            </tr>
                                                    
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            @for(grpAttribute of selectedNode.data.nodeData.groupAttributes; track grpAttribute; let i = $index){
                                                                                            <tr>
                                                                                                <td>{{ i + 1 }}</td>
                                                                                                <td> 
                                                                                                    <input type="text" class="form-control form-control" [(ngModel)]="grpAttribute.aliasName" (blur)="updateNode('groupAttribute')"> 
                                                                                                </td>
                                                                                                <td>
                                                                                                    <ng-select [items]="grpAttribute.selectColumnDropdown" bindLabel="label" groupBy="group" (change)="updateNode('groupAttribute')"
                                                                                                        placeholder="Select a Column" [searchable]="true" [(ngModel)]="grpAttribute.selectedColumn" [dropdownPosition]="'bottom'">
                                                                                                    </ng-select>
                                                                                                </td>
                                                                                                <td> {{grpAttribute?.selectedColumn?.dataType}} </td>
                                                                                                <td style="display: flex; align-items: center; justify-content: center;">
                                                                                                    <button class="btn btn-outline-danger" ngbTooltip="Delete" [triggers]="'hover'"
                                                                                                        (click)="deleteGroupAttribute(i)">
                                                                                                        <i class="fa fa-trash"></i>
                                                                                                    </button>
                                                                                                </td>
                                                                                            </tr>
                                                                                            }
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </ng-template>
                                                                </li>
                                                                <li *ngIf="selectedNode.data.type === 'source_data_object'" [ngbNavItem]="4" className="nav-link text-start"
                                                                    id="source-attributes-tab"><a ngbNavLink>Source Attributes</a>
                                                                    <ng-template ngbNavContent>
                                                                        <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                            <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                <div class="d-flex justify-content-end align-items-center gap-2 mb-3">
                                                                                    <button class="btn btn-sm btn-primary d-flex align-items-center" ngbTooltip="Add" [triggers]="'hover'" [triggers]="'hover'"
                                                                                        (click)="isSourceClicked = true; openAttributesSelection(attributesSelection)">
                                                                                        <i class="fa fa-plus me-1"></i> Select Attribute To Add
                                                                                    </button>
                                                    
                                                                                    <div class="input-group input-group-sm" style="max-width: 200px; height: 29px;">
                                                                                        <input type="text" class="form-control" placeholder="Search" />
                                                                                        <span class="input-group-text bg-primary" ngbTooltip="Search" [triggers]="'hover'">
                                                                                            <i class="fa fa-search text-light"></i>
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                                                <div style="height: 240px;">
                                                                                    <table
                                                                                        class="table border text-nowrap text-md-nowrap table-striped table-bordered mb-0">
                                                                                        <thead class="Result-preview-table-sticky">
                                                                                            <tr>
                                                                                                <th>#</th>
                                                                                                <th>Attribute</th>
                                                                                                <th>Data Type</th>
                                                                                                <th>Src Column Name</th>
                                                                                                <th>Src Data Type</th>
                                                                                                <th>Action</th>
                                                                                            </tr>
                                                    
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            @for(sourceAttribute of selectedNode.data.nodeData.sourceAttributes; track sourceAttribute; let i = $index){
                                                                                            <tr>
                                                                                                <td>{{ i + 1 }}</td>
                                                                                                <td>
                                                                                                    <input type="text" class="form-control form-control" [(ngModel)]="sourceAttribute.attributeName"
                                                                                                        (blur)="updateNode('')">
                                                                                                </td>
                                                                                                <td>
                                                                                                    <select class="form-select form-select" [(ngModel)]="sourceAttribute.dataType" (change)="updateNode('')">
                                                                                                        <option value="">Select</option>
                                                                                                        <option value="integer">integer</option>
                                                                                                        <option value="float">float</option>
                                                                                                        <option value="varchar">varchar</option>
                                                                                                        <option value="boolean">boolean</option>
                                                                                                        <option value="date">date</option>
                                                                                                        <option value="bigint">bigint</option>
                                                                                                        <option value="char">char</option>
                                                                                                        <option value="decimal">decimal</option>
                                                                                                        <option value="time">time</option>
                                                                                                        <option value="time with time zone">time with time zone</option>
                                                                                                        <option value="timestamp">timestamp</option>
                                                                                                        <option value="timestamp with time zone">timestamp with time zone</option>
                                                                                                        <option value="character varying">character varying</option>
                                                                                                    </select>
                                                                                                </td>
                                                                                                <td>
                                                                                                    <ng-select [items]="sourceAttribute.selectColumnDropdown" bindLabel="label" groupBy="group"
                                                                                                        (change)="updateNode('groupAttribute')" placeholder="Select a Column" [searchable]="true"
                                                                                                        [(ngModel)]="sourceAttribute.selectedColumn" [dropdownPosition]="'bottom'">
                                                                                                    </ng-select>
                                                                                                </td>
                                                                                                <td> {{sourceAttribute?.selectedColumn?.dataType}} </td>
                                                                                                <td style="display: flex; align-items: center; justify-content: center;">
                                                                                                    <button class="btn btn-outline-danger" ngbTooltip="Delete" [triggers]="'hover'"
                                                                                                        (click)="deleteSourceAttribute(i)">
                                                                                                        <i class="fa fa-trash"></i>
                                                                                                    </button>
                                                                                                </td>
                                                                                            </tr>
                                                                                            }
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </ng-template>
                                                                </li>
                                                                <li *ngIf="selectedNode.data.type !== 'Filter'" [ngbNavItem]="5" className="nav-link text-start" id="attributes-tab"><a ngbNavLink>Attributes</a>
                                                                    <ng-template ngbNavContent>
                                                                        <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                            <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                @if(selectedNode.data.type === 'target_data_object'){
                                                                                <table
                                                                                    class="table border text-nowrap text-md-nowrap table-striped table-bordered mb-0 mt-1"
                                                                                    style="height: 270px;">
                                                                                    <thead class="Result-preview-table-sticky">
                                                                                        <tr>
                                                                                            <th>#</th>
                                                                                            <th>Attribute</th>
                                                                                            <th>Data Type</th>
                                                                                            <th>Not Null</th>
                                                                                            <th>Key Type</th>
                                                                                        </tr>
                                                    
                                                                                    </thead>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td>1</td>
                                                                                            <td>sdfb</td>
                                                                                            <td>sdn</td>
                                                                                            <td> <input type="checkbox" checked="true" disabled> </td>
                                                                                            <td>primary key</td>
                                                                                        </tr>
                                                                                        <tr>
                                                                                            <td>2</td>
                                                                                            <td>sdfb</td>
                                                                                            <td>sdn</td>
                                                                                            <td> <input type="checkbox" checked="false" disabled> </td>
                                                                                            <td>Not a Key</td>
                                                                                        </tr>
                                                                                        <tr>
                                                                                            <td>3</td>
                                                                                            <td>sdfb</td>
                                                                                            <td>sdn</td>
                                                                                            <td> <input type="checkbox" checked="false" disabled> </td>
                                                                                            <td>Not a Key</td>
                                                                                        </tr>
                                                                                    </tbody>
                                                                                </table>
                                                                                } @else{
                                                                                @if(selectedNode.data.nodeData.attributes.length > 0){
                                                                                <div class="d-flex justify-content-end align-items-center gap-2 mb-3">
                                                                                    <button class="btn btn-sm btn-primary d-flex align-items-center" ngbTooltip="Add" [triggers]="'hover'"
                                                                                        (click)="addNewAttribute()">
                                                                                        <i class="fa fa-plus me-1"></i> Add
                                                                                    </button>
                                                                                    <button *ngIf="selectedNode.data.type !== 'Rollup'" class="btn btn-sm btn-primary d-flex align-items-center" ngbTooltip="Add" [triggers]="'hover'"
                                                                                        (click)="isSourceClicked = false; openAttributesSelection(attributesSelection)">
                                                                                        <i class="fa fa-plus me-1"></i> Select Attribute To Add
                                                                                    </button>
                                                    
                                                                                    <div class="input-group input-group-sm" style="max-width: 200px; height: 29px;">
                                                                                        <input type="text" class="form-control" placeholder="Search" />
                                                                                        <span class="input-group-text bg-primary" ngbTooltip="Search" [triggers]="'hover'">
                                                                                            <i class="fa fa-search text-light"></i>
                                                                                        </span>
                                                                                    </div>
                                                                                </div>
                                                    
                                                    
                                                                                <div style="height: 240px; overflow-y: auto;">
                                                                                    <table class="table table-bordered table-striped text-nowrap mb-0">
                                                                                        <thead class="Result-preview-table-sticky table-light sticky-top">
                                                                                            <tr>
                                                                                                <th>#</th>
                                                                                                <th>Attribute</th>
                                                                                                <th>Data Type</th>
                                                                                                <th>Expression</th>
                                                                                                <th>Action</th>
                                                                                            </tr>
                                                    
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            @for(attribute of selectedNode.data.nodeData.attributes; track attribute; let i
                                                                                            = $index){
                                                                                            <tr>
                                                                                                <td>{{ i + 1 }}</td>
                                                                                                <td><input type="text" class="form-control form-control"
                                                                                                        [(ngModel)]="attribute.attributeName"
                                                                                                        (blur)="updateNode('attribute')" /></td>
                                                                                                <td>
                                                                                                    <select class="form-select form-select"
                                                                                                        [(ngModel)]="attribute.dataType" (change)="updateNode('attribute')">
                                                                                                        <option value="">Select</option>
                                                                                                        <option value="integer">integer</option>
                                                                                                        <option value="float">float</option>
                                                                                                        <option value="varchar">varchar</option>
                                                                                                        <option value="boolean">boolean</option>
                                                                                                        <option value="date">date</option>
                                                                                                        <option value="bigint">bigint</option>
                                                                                                        <option value="char">char</option>
                                                                                                        <option value="decimal">decimal</option>
                                                                                                        <option value="time">time</option>
                                                                                                        <option value="time with time zone">time with time zone</option>
                                                                                                        <option value="timestamp">timestamp</option>
                                                                                                        <option value="timestamp with time zone">timestamp with time zone</option>
                                                                                                        <option value="character varying">character varying</option>
                                                                                                    </select>
                                                                                                </td>
                                                                                                <td>
                                                                                                    <div class="input-group input-group">
                                                                                                        <input type="text" class="form-control" [(ngModel)]="attribute.expression" (blur)="updateNode('attribute')"/>
                                                                                                        <span class="input-group-text bg-primary" ngbTooltip="" (click)="openExpressionEdit(expressionEdit, attribute)">
                                                                                                            <i class="fa-solid fa-up-right-from-square"></i>
                                                                                                        </span>
                                                                                                    </div>
                                                                                                </td>
                                                                                                <td style="display: flex; align-items: center; justify-content: center;">
                                                                                                    <button class="btn btn-outline-danger" ngbTooltip="Delete" [triggers]="'hover'"
                                                                                                        (click)="deleteAttribute(i)">
                                                                                                        <i class="fa fa-trash"></i>
                                                                                                    </button>
                                                                                                </td>
                                                                                            </tr>
                                                                                            }
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                                } @else{
                                                                                <div class="d-flex">
                                                                                    <span>No Attribute exists, to add </span> &nbsp;
                                                                                    <button class="btn btn-sm btn-primary d-flex align-items-center" ngbTooltip="Add Attribute" [triggers]="'hover'" (click)="addNewAttribute()">
                                                                                        <i class="fa fa-plus me-2"></i> Click Here
                                                                                    </button> &nbsp;
                                                                                    <span *ngIf="selectedNode.data.type !== 'Rollup'"> or select Attributes</span> &nbsp;
                                                                                    <button *ngIf="selectedNode.data.type !== 'Rollup'" class="btn btn-sm btn-primary d-flex align-items-center" ngbTooltip="Add" [triggers]="'hover'"
                                                                                        (click)="isSourceClicked = false; openAttributesSelection(attributesSelection)">
                                                                                        <i class="fa fa-plus me-1"></i> Click Here
                                                                                    </button>
                                                                                </div>
                                                                                }
                                                                                }
                                                                            </div>
                                                                        </div>
                                                                    </ng-template>
                                                                </li>
                                                                <!-- <li *ngIf="selectedNode.data.type === 'target_data_object'" [ngbNavItem]="6" className="nav-link text-start"
                                                                    id="attribute-mapper-tab"><a ngbNavLink>Attribute Mapper</a>
                                                                    <ng-template ngbNavContent>
                                                                        <div class="tab-pane " id="quarters" role="tabpanel" aria-labelledby="quarters-tab" tabindex="0">
                                                                            <div class="col-xl-12 col-lg-12 col-md-12">
                                                                                <div style="height: 30px; display: flex;">
                                                                                    <label for="loadType" class="me-2">Load Type: </label>
                                                                                    <select name="loadType" id="loadType" class="me-2">
                                                                                        <option value="">Insert</option>
                                                                                        <option value="">Update</option>
                                                                                        <option value="">Upsert</option>
                                                                                        <option value="">Delete</option>
                                                                                        <option value="">SCD</option>
                                                                                    </select>
                                                                                    <img src="./assets/images/etl/unlink-etl.svg" alt="unlink" ngbTooltip="unlink"
                                                                                        class="drawflow-image me-2">
                                                                                    <img src="./assets/images/etl/unlinkall-etl.svg" alt="unlinkAll" ngbTooltip="unlinkAll"
                                                                                        class="drawflow-image me-2">
                                                                                    <img src="./assets/images/etl/automap-etl.svg" alt="automap" ngbTooltip="automap"
                                                                                        class="drawflow-image">
                                                                                </div>
                                                                                <div style="height: 234px;" class="mt-3">
                                                                                    <table
                                                                                        class="table border text-nowrap text-md-nowrap table-striped table-bordered mb-0">
                                                                                        <thead class="Result-preview-table-sticky">
                                                                                            <tr>
                                                                                                <th>Target Attribute</th>
                                                                                                <th>Tgt Data Type</th>
                                                                                                <th>Source Attribute</th>
                                                                                                <th>Src Data Type</th>
                                                                                            </tr>
                                                                                        </thead>
                                                                                        <tbody>
                                                                                            <tr>
                                                                                                <td>aaa</td>
                                                                                                <td>integer</td>
                                                                                                <td>
                                                                                                    <select name="" id="">
                                                                                                        <option value="">aaa</option>
                                                                                                        <option value="">bbb</option>
                                                                                                        <option value="">ccc</option>
                                                                                                        <option value="">ddd</option>
                                                                                                        <option value="">eee</option>
                                                                                                    </select>
                                                                                                </td>
                                                                                                <td>integer</td>
                                                                                            </tr>
                                                                                            <tr>
                                                                                                <td>aaa</td>
                                                                                                <td>integer</td>
                                                                                                <td>
                                                                                                    <select name="" id="">
                                                                                                        <option value="">aaa</option>
                                                                                                        <option value="">bbb</option>
                                                                                                        <option value="">ccc</option>
                                                                                                        <option value="">ddd</option>
                                                                                                        <option value="">eee</option>
                                                                                                    </select>
                                                                                                </td>
                                                                                                <td>integer</td>
                                                                                            </tr>
                                                                                            <tr>
                                                                                                <td>aaa</td>
                                                                                                <td>integer</td>
                                                                                                <td>
                                                                                                    <select name="" id="">
                                                                                                        <option value="">aaa</option>
                                                                                                        <option value="">bbb</option>
                                                                                                        <option value="">ccc</option>
                                                                                                        <option value="">ddd</option>
                                                                                                        <option value="">eee</option>
                                                                                                    </select>
                                                                                                </td>
                                                                                                <td>integer</td>
                                                                                            </tr>
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </ng-template>
                                                                </li> -->
                                                            </ul>
                                                        </div>
                                                    
                                                        <div class="p-2 node-table-right">
                                                            <div class="tab-content" id="vertical-tabContent">
                                                                <div [ngbNavOutlet]="tableTabs"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </ng-template>
                                            </li>
                                            <li *ngIf="isLogShow" [ngbNavItem]="2" (click)="getDataFlowLogs(selectedNode.data.nodeData.general.name)"> <a ngbNavLink class="p-3 TabShadow"> Logs </a>
                                                <ng-template ngbNavContent>
                                                    {{ logs | json }}
                                                </ng-template>
                                            </li>
                                        </ul>
                                        <!-- <div class="d-flex align-items-center">
                                            <h6 class="mb-0 me-2"> {{selectedNode.data.nodeData.general.name}} </h6>
                                        </div>  -->
                                        <div class="d-flex justify-content-end align-items-center me-1">
                                            <button class="btn btn-sm btn-danger" (click)="isNodeSelected = false">
                                                <i class="mdi mdi-close"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="d-lg-flex d-block">
                                        <div class="tab-content" id="vertical-tabContent" style="width: 100%;">
                                            <div [ngbNavOutlet]="tableTypes"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer p-3">
                    
                </div>
            </div>
        </div>
    </div>
</div>

<ng-template #connectionList let-modal>
    <div class="modal-header">
        <h6 class="modal-title">Data Objects</h6>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')">
        </button>
    </div>
    <div class="modal-body">
        <div class="panel panel-primary">
            <div class="tables-modal">
                <label for="connection">Select connection <span class="text-danger">*</span></label>
                <ng-select [items]="connectionOptions" bindLabel="display_name" placeholder="Select a connection" [searchable]="true" 
                    [(ngModel)]="selectedConnection" (change)="getDataObjects()" name="connection" id="connection">
                </ng-select>
                <div *ngIf="nodeToAdd === 'target_data_object'" class="d-flex gap-3 align-items-center mb-2">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="objectType" id="selectObject" [(ngModel)]="objectType" [value]="'select'" (click)="selectedDataObject = null">
                      <label class="form-check-label" for="selectObject">Select Object</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="objectType" id="createObject" [(ngModel)]="objectType" [value]="'create'" (click)="selectedDataObject = null">
                      <label class="form-check-label" for="createObject">Create Object</label>
                    </div>
                </div>
                <div *ngIf="objectType === 'select'">
                    <label for="dataObject" class="mt-1">Select Data Object <span class="text-danger">*</span></label>
                    <ng-select [items]="dataObjectOptions" bindLabel="tables" placeholder="Select a Data Object" [searchable]="true" 
                        [(ngModel)]="selectedDataObject" name="dataObject" id="dataObject" [disabled]="!selectedConnection">
                    </ng-select>
                </div>
                <div *ngIf="objectType === 'create'">
                    <label for="newObjectName" class="form-label mt-2">New Object Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="newObjectName" [(ngModel)]="selectedDataObject" name="newObjectName" [disabled]="!selectedConnection" placeholder="Data Object Name">
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <div class="text-right">
            <button type="button" class="btn ripple btn-secondary me-2"
                (click)="modal.close('Cross click'); objectType = 'select'; selectedConnection = null; selectedDataObject = null;">Cancel</button>
            <button type="button" [disabled]="!selectedConnection || !selectedDataObject" class="btn ripple btn-primary" (click)="addNode(nodeToAdd, posX, posY); modal.dismiss('Save click')">Ok</button>
        </div>
    </div>
</ng-template>

<ng-template #expressionEdit let-modal>
    <div class="modal-header">
        <h5 class="modal-title">Expression Editor - {{selectedNode.data.nodeData.general.name}} ({{selectedNode.data.type}}) </h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
    </div>

    <div class="modal-body p-3">

        <div class="mb-2 d-flex justify-content-between align-items-center">
            <label class="form-label mb-0"><b>*{{selectedField.attributeName}} ({{selectedField.dataType}})</b></label>
            <!-- <div class="d-flex flex-wrap gap-2">
            <button *ngFor="let op of operators"
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    >
              {{ op }}
            </button>
          </div> -->
        </div>

        <div class="mb-3">
            <textarea class="form-control" rows="6" placeholder="Enter expression..." [(ngModel)]="expression"
                style="width: 100%;">
            </textarea>
        </div>

        <!-- TABLE WRAPPER -->
        <div>
            <table class="table table-bordered w-100">
                <thead>
                    <tr>
                        <th class="fw-bold bg-primary text-white">Transforms</th>
                        <th class="fw-bold bg-primary text-white">Selected Transform</th>
                        <th class="fw-bold bg-primary text-white">Selected Column</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>

                        <!-- Transforms Column -->
                        <td class="align-top" style="width: 33%; max-height: 200px;">
                            <div *ngFor="let field of ['aa', 'bb']" class="text-break py-1 px-2 hover-bg"
                                style="cursor: pointer;">
                                {{ field }}
                            </div>
                        </td>

                        <!-- Selected Transform -->
                        <td class="align-top" style="width: 33%; max-height: 200px; overflow: auto;">
                            <input type="text" class="form-control form-control-sm mb-2" placeholder="Search fields..."
                                [(ngModel)]="searchText" />
                            <div *ngFor="let field of fields" class="text-break py-1 px-2 hover-bg"
                                style="cursor: pointer;">
                                {{ field }}
                            </div>
                        </td>

                        <!-- Selected Column -->
                        <td class="align-top" style="width: 34%;">
                            <div *ngIf="selectedField">
                                <div><b>{{ selectedField }}</b></div>
                                <div>Data type: varchar</div>
                                <div>Not Null: false</div>
                                <div>Key Type: Not a Key</div>
                            </div>
                            <div *ngIf="!selectedField" class="text-muted">No column selected</div>
                        </td>

                    </tr>
                </tbody>
            </table>
        </div>

    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary">Validate</button>
        <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss('cancel')">Cancel</button>
        <button type="button" class="btn btn-primary">OK</button>
    </div>
</ng-template>

<ng-template #attributesSelection let-modal>
    <div class="modal-header">
        <h5 class="modal-title">Select Attributes</h5>
        <button type="button" class="btn-close" (click)="modal.dismiss('Cross click')"></button>
    </div>

    <div class="modal-body">

        <input type="text" [(ngModel)]="searchText" class="form-control mb-3" placeholder="Search..." />



        <div *ngFor="let group of groupAttributesList" class="mb-3">
            <!-- Group Header Checkbox -->
            <div class="form-check mb-2 mt-2">
                <input class="form-check-input border border-dark" type="checkbox" [(ngModel)]="group.isChecked"
                    [id]="'group-' + group.group" (change)="toggleGroup(group)" />
                <label class="form-check-label fw-bold" [for]="'group-' + group.group">
                    {{ group.group }}
                </label>
            </div>

            <!-- Attributes -->
            <div class="form-check mb-1" *ngFor="let attr of group.attributes">
                <input class="form-check-input border border-dark" type="checkbox" [(ngModel)]="attr.isChecked"
                    [id]="attr.label" />
                <label class="form-check-label" [for]="attr.label">
                    {{ attr.label }}
                </label>
            </div>
        </div>
    </div>

    <div class="modal-footer bg-light">
        <button class="btn btn-primary" (click)="applySelectedAttributes(); modal.dismiss('Save click')"> OK </button>
        <button class="btn btn-outline-secondary" (click)="modal.dismiss('cancel')"> Cancel </button>
    </div>
</ng-template>
  